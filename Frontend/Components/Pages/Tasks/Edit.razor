@page "/tasks/edit"
@rendermode InteractiveServer

@using System.Text
@using System.Text.Json
@using System.Net.Http.Json
@using Frontend.Services
@using Frontend.Services.Constants
@using Microsoft.AspNetCore.Components
@inject HttpClient Http
@inject Frontend.Services.Interfaces.IJsTokenStorage JsTokenStorage
@inject NavigationManager Nav

<PageTitle>@Verb Task</PageTitle>

<h3>@Verb Task</h3>

<p>Trying some things out in Blazor, acceptance criteria / specs for this page</p>

<ul>
    <li>Any authenticated user can create a task</li>
    <li>When a task gets created it is unassigned and in status 'Pending' by default</li>
    <li>A regular user can change the status
        <ul>
            <li>When changing from Pending the task will be assigned to this user.</li>
        </ul>
    </li>
    <li>Only an admin can change the assigned user</li>
</ul>

<div>
    <div class="form-row">
        <label>Title</label>
        @if (IsNew || IsAdmin)
        {
            <input @bind="taskModel.Title" />
        }
        else
        {
            @taskModel.Title
        }
    </div>
    <div class="form-row">
        <label>Description</label>
        @if (IsNew || IsAdmin)
        {
            <input @bind="taskModel.Description" />
        }
        else
        {
            @taskModel.Description
        }
    </div>

    @if (!IsNew)
    {
        <div class="form-row">
            <label>Status</label>
            <select @bind="taskModel.StatusId">
                @foreach (var status in taskStatuses)
                {
                    <option value="@status.Id">@status.Status</option>
                }
            </select>            
        </div>
        <div class="form-row">
            <label>Assigned User</label>

		    @if (IsAdmin)
            {
                <select @bind="taskModel.AssignedUserId">
                    @foreach (var user in users)
                    {
                        <option value="@user.Id">@user.Username</option>
                    }
                </select>
            }
            else
            {
                @if (taskModel.AssignedUserId == 0)
                { 
                    <span>- unassigned -</span>
                }
                else
                {
                    @currentUser.Username
                }
            }
        </div>
    }    

    <div style="margin-top:8px">
        <button type="button" @onclick="SubmitAsync">@Verb Task</button>
    </div>

    @if (!string.IsNullOrEmpty(Message))
    {
        <p>@Message</p>
    }
</div>

@code {
    private string Verb = "Add";
    private string? Message;    
    private bool IsNew = true;
    private bool IsAdmin = false;
    
    private UpsertTaskModel taskModel = new();
    private List<TaskStatusModel> taskStatuses = [];
    private List<UserModel> users = [];
    private UserModel currentUser = new();
    private string Status = "";

    [Parameter]
    [SupplyParameterFromQuery(Name = "id")]
    public int? Id { get; set; }

    protected override void OnInitialized()
    {
        if (Id.HasValue)
        {
            IsNew = false;
            Verb = "Update";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            if (firstRender)
            {
                var token = await JsTokenStorage!.GetTokenAsync(TokenConstants.JwtTokenKey);
                var isAdmin = await JsTokenStorage!.GetTokenAsync(TokenConstants.IsAdminKey);
				IsAdmin = isAdmin == "1";

                taskStatuses = await LoadTaskStatuses(token!);

                if (!IsNew)
                {
                    taskModel = await LoadTask(token!);
                    Status = taskStatuses.Where(x => x.Id == taskModel.StatusId).First().Status;
                }                

                if (IsAdmin)
                {
                    users = await LoadUsers(token!);
                }
                else
                {
                    currentUser = await LoadUser(token!);                    
                }

                StateHasChanged();
            }
        }
        catch
        {
            // ignore
        }
    }

    private async Task<UpsertTaskModel> LoadTask(string token)
    { 
        using var request = new HttpRequestMessage(HttpMethod.Get, $"api/task/{Id}");

        if (!string.IsNullOrEmpty(token))
        {
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }

        var response = await Http.SendAsync(request);
        var result = new UpsertTaskModel();

        if (response.IsSuccessStatusCode)
        {
            result = await response.Content.ReadFromJsonAsync<UpsertTaskModel>() ?? new();
        }

        return result;
    }

    private async Task<List<TaskStatusModel>> LoadTaskStatuses(string token)
    {
        using var request = new HttpRequestMessage(HttpMethod.Get, $"api/task/statuslist");

        if (!string.IsNullOrEmpty(token))
        {
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }

        var response = await Http.SendAsync(request);    
        var result = new List<TaskStatusModel>();

        if (response.IsSuccessStatusCode)
        {
            result = await response.Content.ReadFromJsonAsync<List<TaskStatusModel>>() ?? new();
        }

        return result;
    }

    private async Task<UserModel> LoadUser(string token)
    {
        var userId = await JsTokenStorage!.GetTokenAsync(TokenConstants.UserIdKey);
        using var request = new HttpRequestMessage(HttpMethod.Get, $"api/user/{userId}");

        if (!string.IsNullOrEmpty(token))
        {
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }

        var response = await Http.SendAsync(request);
        var result = new UserModel();

        if (response.IsSuccessStatusCode)
        {
            result = await response.Content.ReadFromJsonAsync<UserModel>() ?? new();
        }

        return result;
    }

    private async Task<List<UserModel>> LoadUsers(string token)
    {
        using var request = new HttpRequestMessage(HttpMethod.Get, "api/user");

        if (!string.IsNullOrEmpty(token))
        {
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }

        var response = await Http.SendAsync(request);
        var result = new List<UserModel>();

        if (response.IsSuccessStatusCode)
        {
            result = await response.Content.ReadFromJsonAsync<List<UserModel>>() ?? [];
        }

        return result;
    }

    private async Task SubmitAsync()
    {
        Message = null;

        var payload = GetPayload();

        try
        {
            var token = await JsTokenStorage.GetTokenAsync(TokenConstants.JwtTokenKey);
            if (string.IsNullOrEmpty(token))
            {
                Nav.NavigateTo("/", true);
                return;
            }

            var json = JsonSerializer.Serialize(payload);
            using var content = new StringContent(json, Encoding.UTF8, "application/json");

            using var request = IsNew
                ? new HttpRequestMessage(HttpMethod.Post, $"/api/task") { Content = content }
                : new HttpRequestMessage(new HttpMethod("PATCH"), "/api/task") { Content = content };

            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.SendAsync(request);
            var responseBody = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                StateHasChanged();
                Nav.NavigateTo("/tasks/list", true);
            }
            else
            {
                Message = $"Request failed ({(int)response.StatusCode}): {responseBody}";
            }
        }
        catch (Exception ex)
        {
            Message = ex.Message;
        }
    }

    private object GetPayload()
    {
        if (IsNew)
        {
            var statusId = taskStatuses.Where(x => x.Status.ToLower() == "pending").First().Id;

            return new
            {
                statusId,
                title = taskModel.Title,
                description = taskModel.Description
            };
        }
        else
        {
            return new
            {
                id = taskModel.Id,
                title = taskModel.Title,
                description = taskModel.Description,
                statusId = taskModel.StatusId,
                assignedUserId = !IsAdmin && taskModel.AssignedUserId == 0 ? currentUser.Id : taskModel.AssignedUserId,
            };
        }
    }

    private class TaskStatusModel
    {
        public long Id { get; set; }
        public string Status { get; set; } = string.Empty;
        public bool IsActive { get; set; }
    }

    private class UserModel
    {
        public long Id { get; set; }
		public string Username { get; set; } = string.Empty;
    }

    private class UpsertTaskModel
    {
        public long? Id { get; set; }
        public string Title { get; set; } = "";
        public string Description { get; set; } = ""; 
        public long StatusId { get; set; }
        public long AssignedUserId { get; set; }
    }
}
