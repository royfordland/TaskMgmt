@page "/tasks/edit"
@rendermode InteractiveServer

@using System.Text
@using System.Text.Json
@using System.Net.Http.Json
@using Frontend.Services
@using Frontend.Services.Constants
@using Microsoft.AspNetCore.Components
@inject HttpClient Http
@inject Frontend.Services.Interfaces.IJsTokenStorage JsTokenStorage
@inject IJSRuntime JS
@inject NavigationManager Nav

<PageTitle>@Verb Task</PageTitle>

<h3>@Verb Task</h3>

<p>Trying some things out in Blazor, acceptance criteria / specs for this page</p>

<ul>
    <li>Any authenticated user can create a task</li>
    <li>When a task gets created it is unassigned and in status 'Pending' by default</li>
    <li>A regular user can change the status
        <ul>
            <li>When changing from Pending the task will be assigned to this user.</li>
        </ul>
    </li>
    <li>Only an admin can change the assigned user</li>
</ul>

<div>
    <div>
        <label>Title</label><br />
        <input @bind="taskModel.Title" />
    </div>
    <div>
        <label>Description</label><br />
        <input @bind="taskModel.Description" />
    </div>

    @if (!IsNew)
    {
        <div>
            <label>Status</label><br />
            <select @bind="taskModel.StatusId">
                @foreach (var status in taskStatuses)
                {
                    <option value="@status.Id">@status.Status</option>
			    }
            </select>
        </div>
        <div>
            <label>Assigned User</label><br />

		    @if (IsAdmin)
            {                
                <select @bind="taskModel.AssignedUserId">
                    <option>-- Select a User --</option>
                    @foreach (var user in users)
                    {
                        <option value="@user.Id">@user.Username</option>
                    }
                </select>           
            }
            else
            {
                @currentUser.Username
            }
        </div>
    }    

    <div style="margin-top:8px">
        <button type="button" @onclick="SubmitAsync">@Verb Task Status</button>
    </div>

    @if (!string.IsNullOrEmpty(Message))
    {
        <p>@Message</p>
    }
</div>

@code {
    private string Verb = "Add";
    private string? Message;    
    private bool IsNew = true;
    private bool IsAdmin = false;
    private JsTokenStorage? _jsTokenStorage;

    private UpsertTaskModel taskModel = new();
    private List<TaskStatusModel> taskStatuses = [];
    private List<UserModel> users = [];
    private UserModel currentUser = new();

    [Parameter]
    [SupplyParameterFromQuery(Name = "id")]
    public int? Id { get; set; }

    protected override void OnInitialized()
    {
        _jsTokenStorage = new JsTokenStorage(JS);

        if (Id.HasValue)
        {
            IsNew = false;
            Verb = "Edit";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        try
        {
            if (firstRender)
            {
                _jsTokenStorage = new JsTokenStorage(JS);

                var token = await _jsTokenStorage!.GetTokenAsync(TokenConstants.JwtTokenKey);
                var isAdmin = await _jsTokenStorage!.GetTokenAsync(TokenConstants.IsAdminKey);

                if (!IsNew)
                {
                    LoadTask();
                }

                LoadTaskStatuses(token!);

                if (isAdmin == "1")
                {
                    LoadUsers(token!);
                }
                else
                {
                    LoadUser(token!);
                }

                StateHasChanged();
            }
        }
        catch
        {
            // ignore
        }
    }

    private async void LoadTask()
    { 
        var token = await _jsTokenStorage!.GetTokenAsync(TokenConstants.JwtTokenKey);
        using var request = new HttpRequestMessage(HttpMethod.Get, $"api/task/{Id}");

        if (!string.IsNullOrEmpty(token))
        {
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }

        var response = await Http.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            taskModel = await response.Content.ReadFromJsonAsync<UpsertTaskModel>() ?? new();
        }
    }

    private async void LoadTaskStatuses(string token)
    {
        using var request = new HttpRequestMessage(HttpMethod.Get, $"api/task/statuslist");

        if (!string.IsNullOrEmpty(token))
        {
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }

        var response = await Http.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            taskStatuses = await response.Content.ReadFromJsonAsync<List<TaskStatusModel>>() ?? new();
        }
    }

    private async void LoadUser(string token)
    {
        var userId = await _jsTokenStorage!.GetTokenAsync(TokenConstants.UserIdKey);
        using var request = new HttpRequestMessage(HttpMethod.Get, $"api/user/{userId}");

        if (!string.IsNullOrEmpty(token))
        {
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }

        var response = await Http.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            currentUser = await response.Content.ReadFromJsonAsync<UserModel>() ?? new();
        }
    }

    private async void LoadUsers(string token)
    {
        using var request = new HttpRequestMessage(HttpMethod.Get, "api/user");

        if (!string.IsNullOrEmpty(token))
        {
            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
        }

        var response = await Http.SendAsync(request);

        if (response.IsSuccessStatusCode)
        {
            users = await response.Content.ReadFromJsonAsync<List<UserModel>>() ?? [];
        }
    }

    private async Task SubmitAsync()
    {
        Message = null;

        var payload = GetPayload();

        try
        {
            var token = await JsTokenStorage.GetTokenAsync(TokenConstants.JwtTokenKey);
            if (string.IsNullOrEmpty(token))
            {
                Nav.NavigateTo("/");
                return;
            }

            var json = JsonSerializer.Serialize(payload);
            using var content = new StringContent(json, Encoding.UTF8, "application/json");

            using var request = IsNew
                ? new HttpRequestMessage(HttpMethod.Post, $"/api/task") { Content = content }
                : new HttpRequestMessage(new HttpMethod("PATCH"), "/api/task") { Content = content };

            request.Headers.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

            var response = await Http.SendAsync(request);
            var responseBody = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                Nav.NavigateTo("/admin/taskstatus/list");
            }
            else
            {
                Message = $"Request failed ({(int)response.StatusCode}): {responseBody}";
            }
        }
        catch (Exception ex)
        {
            Message = ex.Message;
        }
    }

    private object GetPayload()
    {
        if (IsNew)
        {
            var statusId = taskStatuses.Where(x => x.Status.ToLower() == "pending").First().Id;

            return new
            {
                statusId,
                title = taskModel.Title,
                description = taskModel.Description
            };
        }
        else
        {
            return new
            {
                id = taskModel.Id,
                title = taskModel.Title,
                description = taskModel.Description,
                statusId = taskModel.StatusId,
                assignedUserId = taskModel.AssignedUserId,
            };
        }
    }

    private class TaskStatusModel
    {
        public long Id { get; set; }
        public string Status { get; set; } = string.Empty;
        public bool IsActive { get; set; }
    }

    private class UserModel
    {
        public long Id { get; set; }
		public string Username { get; set; } = string.Empty;
    }

    private class UpsertTaskModel
    {
        public int? Id { get; set; }
        public string Title { get; set; } = "";
        public string Description { get; set; } = ""; 
        public int StatusId { get; set; }
        public int AssignedUserId { get; set; }
    }
}
